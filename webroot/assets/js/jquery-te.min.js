!function(e){e.fn.jqte=function(t){function s(e,t,s,i,n){var l=r.length+1;return r.push({name:e,cls:l,command:t,key:s,tag:i,emphasis:n})}var i=[{title:"Font Size"},{title:"Color"},{title:"Bold",hotkey:"B"},{title:"Italic",hotkey:"I"},{title:"Underline",hotkey:"U"},{title:"Ordered List",hotkey:"."},{title:"Unordered List",hotkey:","},{title:"Subscript",hotkey:"down arrow"},{title:"Superscript",hotkey:"up arrow"},{title:"Outdent",hotkey:"left arrow"},{title:"Indent",hotkey:"right arrow"},{title:"Justify Left"},{title:"Justify Center"},{title:"Justify Right"},{title:"Strike Through",hotkey:"K"},{title:"Add Link",hotkey:"L"},{title:"Remove Link"},{title:"Cleaner Style",hotkey:"Delete"},{title:"Horizontal Rule",hotkey:"H"},{title:"Source"}],n=["10","12","16","18","20","24","28"],l=["0,0,0","68,68,68","102,102,102","153,153,153","204,204,204","238,238,238","243,243,243","255,255,255","244,204,204","252,229,205","255,242,204","217,234,211","208,224,227","207,226,243","217,210,233","234,209,220","234,153,153","249,203,156","255,229,153","182,215,168","162,196,201","159,197,232","180,167,214","213,166,189","224,102,102","246,178,107","255,217,102","147,196,125","118,165,175","111,168,220","142,124,195","194,123,160","255,0,0","255,153,0","255,255,0","0,255,0","0,255,255","0,0,255","153,0,255","255,0,255","204,0,0","230,145,56","241,194,50","106,168,79","69,129,142","61,133,198","103,78,167","166,77,121","153,0,0","180,95,6","191,144,0","56,118,29","19,79,92","11,83,148","53,28,117","116,27,71","102,0,0","120,63,4","127,96,0","39,78,19","12,52,61","7,55,99","32,18,77","76,17,48"],a=["Web Address","E-mail Address","Picture URL"],o=e.extend({css:"jqte",title:!0,titletext:i,button:"OK",fsize:!0,fsizes:n,funit:"px",color:!0,linktypes:a,b:!0,i:!0,u:!0,ol:!0,ul:!0,sub:!0,sup:!0,outdent:!0,indent:!0,left:!0,center:!0,right:!0,strike:!0,link:!0,unlink:!0,remove:!0,rule:!0,source:!0},t),c=navigator.userAgent.toLowerCase();/msie [1-7]./.test(c)&&(o.title=!1);var r=[];return s("fsize","fSize","","",!1),s("color","colors","","",!1),s("b","Bold","B",["b","strong"],!0),s("i","Italic","I",["i","em"],!0),s("u","Underline","U",["u"],!0),s("ol","insertorderedlist","¾",["ol"],!0),s("ul","insertunorderedlist","¼",["ul"],!0),s("sub","subscript","(",["sub"],!0),s("sup","superscript","&",["sup"],!0),s("outdent","outdent","%",["blockquote"],!1),s("indent","indent","'",["blockquote"],!0),s("left","justifyLeft","","",!1),s("center","justifyCenter","","",!1),s("right","justifyRight","","",!1),s("strike","strikeThrough","K",["strike"],!0),s("link","linkcreator","L",["a"],!0),s("unlink","unlink","",["a"],!1),s("remove","removeformat",".","",!1),s("rule","inserthorizontalrule","H",["hr"],!1),s("source","displaysource","","",!1),this.each(function(){function t(){return window.getSelection?window.getSelection():document.selection&&document.selection.createRange&&"None"!=document.selection.type?document.selection.createRange():void 0}function s(e,s){var i,n=t();window.getSelection?(n.anchorNode&&n.getRangeAt&&(i=n.getRangeAt(0)),i&&(n.removeAllRanges(),n.addRange(i)),c.match(/msie/)||(document.execCommand("StyleWithCSS",!1,!1),document.execCommand(e,!1,s))):document.selection&&document.selection.createRange&&"None"!=document.selection.type&&(i=document.selection.createRange(),i.execCommand(e,!1,s)),a()}function i(s,i,n){if(F.not(":focus")&&F.focus(),window.getSelection){var l,o,c,r=t();r.anchorNode&&r.getRangeAt&&(l=r.getRangeAt(0),o=document.createElement(s),e(o).attr(i,n),c=l.extractContents(),o.appendChild(c),l.insertNode(o),r.removeAllRanges(),"style"==i?a(e(o),n):a(e(o),!1))}else if(document.selection&&document.selection.createRange&&"None"!=document.selection.type){var d=document.selection.createRange(),u=d.htmlText,f="<"+s+" "+i+'="'+n+'">'+u+"</"+s+">";document.selection.createRange().pasteHTML(f)}}function n(e){var e=e[0];if(document.body.createTextRange){var t=document.body.createTextRange();t.moveToElementText(e),t.select()}else if(window.getSelection){var s=window.getSelection(),t=document.createRange();"undefined"!=e&&null!=e&&t.selectNodeContents(e),s.removeAllRanges(),s.addRange(t)}}function a(e,t){var s=Q();if((s=s?s:e)&&!t)s.parent().is("[style]")&&s.attr("style",s.parent().attr("style")),s.is("[style]")&&s.find("*").attr("style",s.attr("style"));else if(e&&t&&e.is("[style]")){var i=t.split(";");i=i[0].split(":"),e.find("*").css(i[0],i[1])}}function d(){if(S.data("sourceOpened"))f(!1);else{var t=Q(),s="http://";if(f(!0),t){"a"==t.prop("tagName").toLowerCase()&&t.is("[href]")?(s=t.attr("href"),t.attr(D,"")):i("a",D,"")}else N.val(s).focus();T.click(function(t){(e(t.target).hasClass(o.css+"_linktypetext")||e(t.target).hasClass(o.css+"_linktypearrow"))&&h(!0)}),I.find("a").click(function(){var t=e(this).attr(o.css+"-linktype");I.data("linktype",t),q.find("."+o.css+"_linktypetext").html(I.find("a:eq("+I.data("linktype")+")").text()),p(s),h()}),p(s),N.val(s).bind("keypress keyup",function(e){if(13==e.keyCode)return u(A.find("["+D+"]")),!1}).focus(),U.click(function(){u(A.find("["+D+"]"))})}}function u(t){N.focus(),n(t),t.removeAttr(D),"2"!=I.data("linktype")?s("createlink",N.val()):(s("insertImage",N.val()),F.find("img").each(function(){var t=e(this).prev("a"),s=e(this).next("a");t.length>0&&""==emptyLinks.html()?t.remove():s.length>0&&""==s.html()&&s.remove(),e(this).is("[style*=float]")||e(this).css({float:"left",margin:"0 10px 10px 0"})})),f(),_()}function f(e){y("["+D+"]:not([href])"),A.find("["+D+"][href]").removeAttr(D),e?(S.data("linkOpened",!0),O.slideDown(100)):(S.data("linkOpened",!1),O.slideUp(100)),h()}function h(e){e?I.stop(!0,!0).delay(100).slideToggle(100):I.stop(!0,!0).delay(100).slideUp(100)}function p(e){var t=I.data("linktype");"1"!=t||"http://"!=N.val()&&!N.is("[value^=http://]")&&N.is("[value^=mailto]")?"1"==t||N.is("[value^=http://]")?N.val(e):N.val("http://"):N.val("mailto:")}function m(t){S.data("sourceOpened")?v(styleField,!1):("fSize"==t?styleField=J:"colors"==t&&(styleField=P),v(styleField,!0),styleField.find("a").click(function(){var s=e(this).attr(o.css+"-styleval");"fSize"==t?(styleType="font-size",s+=o.funit):"colors"==t&&(styleType="color",s="rgb("+s+")");var n=g(styleType);i("span","style",styleType+":"+s+";"+n),v("",!1),e("."+o.css+"_title").remove(),_()})),f(!1)}function v(e,t){var s="",i=[{d:"fsizeOpened",f:J},{d:"cpallOpened",f:P}];if(""!=e)for(var n=0;n<i.length;n++)e==i[n].f&&(s=i[n]);if(t){S.data(s.d,!0),s.f.slideDown(100);for(var n=0;n<i.length;n++)s.d!=i[n].d&&(S.data(i[n].d,!1),i[n].f.slideUp(100))}else for(var n=0;n<i.length;n++)S.data(i[n].d,!1),i[n].f.slideUp(100)}function y(t){A.find(t).each(function(){e(this).before(e(this).html()).remove()})}function g(e){var t=Q();if(t&&t.is("[style]")&&""!=t.css(e)){var s=t.css(e);t.css(e,"");var i=t.attr("style");return t.css(e,s),i}return""}function k(e){var t,s,i;t=e.replace(/\n/g,"").replace(/\r/g,"").replace(/\t/g,"").replace(/ /g," "),s=[/\<div>(.*?)\<\/div>/gi,/\<br>(.*?)\<br>/gi,/\<br\/>(.*?)\<br\/>/gi,/\<strong>(.*?)\<\/strong>/gi,/\<em>(.*?)\<\/em>/gi],i=["<p>$1</p>","<p>$1</p>","<p>$1</p>","<b>$1</b>","<i>$1</i>"];for(var n=0;n<s.length;n++)t=t.replace(s[n],i[n]);return t}function _(){x.val(k(F.html()))}function b(){F.html(k(x.val()))}function C(t){var s,i=!1,n=Q();return!!n&&(e.each(t,function(t,l){s=n.prop("tagName").toLowerCase(),s==l?i=!0:n.parents().each(function(){(s=e(this).prop("tagName").toLowerCase())==l&&(i=!0)})}),i)}function w(t){for(var s=0;s<r.length;s++)o[r[s].name]&&r[s].emphasis&&""!=r[s].tag&&(C(r[s].tag)?S.find("."+o.css+"_tool_"+r[s].cls).addClass(L):e("."+o.css+"_tool_"+r[s].cls).removeClass(L)),v("",!1)}var x=e(this),R=e(this).is("[value]")||"textarea"==e(this).prop("tagName").toLowerCase()?e(this).val():e(this).html(),z=e(this).is("[name]")?' name="'+e(this).attr("name")+'"':"";x.after('<div class="'+o.css+'" ></div>');var A=x.next("."+o.css);A.html('<div class="'+o.css+'_toolbar" role="toolbar" unselectable></div><div class="'+o.css+'_linkform" style="display:none" role="dialog"></div><div class="'+o.css+'_editor"></div>');var S=A.find("."+o.css+"_toolbar"),O=A.find("."+o.css+"_linkform"),F=A.find("."+o.css+"_editor"),L=o.css+"_tool_depressed";O.append('<div class="'+o.css+'_linktypeselect" unselectable></div> <input class="'+o.css+'_linkinput" type="text/css" value=""> <div class="'+o.css+'_linkbutton" unselectable>'+o.button+'</div> <div style="height:1px;float:none;clear:both"></div>');var T=O.find("."+o.css+"_linktypeselect"),N=O.find("."+o.css+"_linkinput"),U=O.find("."+o.css+"_linkbutton");T.append('<div class="'+o.css+'_linktypeview" unselectable></div><div class="'+o.css+'_linktypes" role="menu" unselectable></div>');var I=T.find("."+o.css+"_linktypes"),q=T.find("."+o.css+"_linktypeview"),D=o.css+"-setlink";o.css;F.after('<div class="'+o.css+"_source "+o.css+'_hiddenField"><textarea '+z+">"+R+"</textarea></div>"),x.remove();var H=A.find("."+o.css+"_source");x=H.find("textarea"),F.attr("contenteditable","true").html(R);for(var j=0;j<r.length;j++)if(o[r[j].name]){var E=r[j].key.length>0&&null!=o.titletext[j].hotkey&&"undefined"!=o.titletext[j].hotkey&&""!=o.titletext[j].hotkey?" (Ctrl+"+o.titletext[j].hotkey+")":"",M=null!=o.titletext[j].title&&"undefined"!=o.titletext[j].title&&""!=o.titletext[j].title?o.titletext[j].title+E:"";if(S.append('<div class="'+o.css+"_tool "+o.css+"_tool_"+r[j].cls+'" role="button" data-tool="'+j+'" unselectable><a class="'+o.css+'_tool_icon" unselectable></a></div>'),S.find("."+o.css+"_tool[data-tool="+j+"]").data({tag:r[j].tag,command:r[j].command,emphasis:r[j].emphasis,title:M}),"fsize"==r[j].name){S.find("."+o.css+"_tool_"+r[j].cls).append('<div class="'+o.css+'_fontsizes" unselectable style="position:absolute;display:none"></div>');for(var W=0;W<o.fsizes.length;W++)S.find("."+o.css+"_fontsizes").append("<a "+o.css+'-styleval="'+o.fsizes[W]+'" class="'+o.css+'_fontsize" style="font-size:'+o.fsizes[W]+o.funit+'" role="menuitem" unselectable>Abcdefgh...</a>')}else if("color"==r[j].name){S.find("."+o.css+"_tool_"+r[j].cls).append('<div class="'+o.css+'_cpalette" unselectable style="position:absolute;display:none"></div>');for(var $=0;$<l.length;$++)S.find("."+o.css+"_cpalette").append("<a "+o.css+'-styleval="'+l[$]+'" class="'+o.css+'_color" style="background-color: rgb('+l[$]+')" role="gridcell" unselectable></a>')}}I.data("linktype","0");for(var j=0;j<3;j++)I.append("<a "+o.css+'-linktype="'+j+'" unselectable>'+o.linktypes[j]+"</a>"),q.html('<div class="'+o.css+'_linktypearrow" unselectable></div><div class="'+o.css+'_linktypetext">'+I.find("a:eq("+I.data("linktype")+")").text()+"</div>");var B="";/msie/.test(c)?B="-ms-":/chrome/.test(c)||/safari/.test(c)||/yandex/.test(c)?B="-webkit-":/mozilla/.test(c)?B="-moz-":/opera/.test(c)?B="-o-":/konqueror/.test(c)&&(B="-khtml-"),A.find("[unselectable]").css(B+"user-select","none").attr("unselectable","on").on("selectstart mousedown",function(e){e.preventDefault()});var K=S.find("."+o.css+"_tool"),J=S.find("."+o.css+"_fontsizes"),P=S.find("."+o.css+"_cpalette"),Q=function(){var t,s;if(window.getSelection&&(s=getSelection(),t=s.anchorNode),!t&&document.selection){s=document.selection;var i=s.getRangeAt?s.getRangeAt(0):s.createRange();t=i.commonAncestorContainer?i.commonAncestorContainer:i.parentElement?i.parentElement():i.item(0)}return!!t&&e("#text"==t.nodeName?t.parentNode:t)};K.click(function(t){"displaysource"!=e(this).data("command")||S.data("sourceOpened")?S.data("sourceOpened")?(S.data("sourceOpened",!1),S.find("."+o.css+"_tool").removeClass(o.css+"_hiddenField"),H.addClass(o.css+"_hiddenField"),F.removeClass(o.css+"_hiddenField"),F.not(":focus")&&F.focus()):"linkcreator"==e(this).data("command")?S.data("linkOpened")?f(!1):d():"fSize"==e(this).data("command")&&!e(t.target).hasClass(o.css+"_fontsize")||"colors"==e(this).data("command")&&!e(t.target).hasClass(o.css+"_color")?m(e(this).data("command")):(F.not(":focus")&&F.focus(),s(e(this).data("command"),null),f(!1),v("",!1),1!=e(this).data("emphasis")||e(this).hasClass(L)?e(this).removeClass(L):e(this).addClass(L),H.addClass(o.css+"_hiddenField"),F.removeClass(o.css+"_hiddenField"),_()):(S.find("."+o.css+"_tool").addClass(o.css+"_hiddenField"),e(this).removeClass(o.css+"_hiddenField"),S.data("sourceOpened",!0),x.css("height",F.outerHeight()),H.removeClass(o.css+"_hiddenField"),F.addClass(o.css+"_hiddenField"),x.focus(),_(),f(!1),v("",!1))}).hover(function(t){if(o.title&&""!=e(this).data("title")&&(e(t.target).hasClass(o.css+"_tool")||e(t.target).hasClass(o.css+"_tool_icon"))){e("."+o.css+"_title").remove(),A.append('<div class="'+o.css+'_title"><div class="'+o.css+'_titleArrow"><div class="'+o.css+'_titleArrowIcon"></div></div><div class="'+o.css+'_titleText">'+e(this).data("title")+"</div></div>");var s=e("."+o.css+"_title:first"),i=(s.find("."+o.css+"_titleArrowIcon"),e(this).position()),n=i.left+e(this).outerWidth()-s.outerWidth()/2-e(this).outerWidth()/2,l=i.top+e(this).outerHeight()+5;s.delay(400).css({top:l,left:n}).fadeIn(200)}},function(){e("."+o.css+"_title").remove()}),F.bind("keypress keyup keydown drop cut copy paste DOMCharacterDataModified DOMSubtreeModified",function(){S.data("sourceOpened")||e(this).trigger("change"),h()}).bind("change",function(){S.data("sourceOpened")||setTimeout(_,0)}).keydown(function(e){if(e.ctrlKey)for(var t=0;t<r.length;t++)if(o[r[t].name]&&e.keyCode==r[t].key.charCodeAt(0))return""!=r[t].command&&"linkcreator"!=r[t].command?s(r[t].command,null):"linkcreator"==r[t].command&&d(),!1}).bind("mouseup keyup",w).focus(function(){h()}).focusout(function(){K.removeClass(L),v("",!1),h()}),x.bind("keydown keyup",function(){setTimeout(b,0),e(this).height(e(this)[0].scrollHeight),""==e(this).val()&&e(this).height(0)})})}}(jQuery);